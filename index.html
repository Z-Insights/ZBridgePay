<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Z-BridgePay Payroll & Document Architect</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Lora:wght@400;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #004D40; /* Dark Teal */
            --secondary-color: #00796B; /* Medium Teal */
            --accent-color: #b28a3d; /* Metallic Gold/Bronze */
            --text-color: #333333;
            --bg-color: #f8f9fa;
            --light-gray: #e0e0e0;
            --white: #ffffff;
            --danger-color: #e74c3c;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--light-gray);
            margin: 0;
            padding: 20px;
            font-size: 11pt;
            color: var(--text-color);
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: var(--white);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }

        header {
            background: linear-gradient(to right, #00796B, #000000);
            color: var(--white);
            padding: 20px 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .logo {
            height: 140px;
            border-radius: 8px;
        }

        .app-title {
            font-size: 28px;
            font-family: 'Playfair Display', serif;
            font-weight: 700;
        }

        .app-subtitle {
            font-size: 16px;
            font-family: 'Lora', serif;
            opacity: 0.9;
            margin-top: 5px;
        }

        .nav-tabs {
            display: flex;
            background: var(--bg-color);
            border-bottom: 1px solid #dce1e5;
        }

        .tab {
            padding: 18px 30px;
            cursor: pointer;
            font-weight: 600;
            color: var(--primary-color);
            transition: all 0.3s ease;
            position: relative;
            font-family: 'Lora', serif;
        }

        .tab.active {
            background: var(--white);
            color: var(--accent-color);
        }

        .tab.active:after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--accent-color);
        }
        
        .tab-content {
            padding: 30px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section-title {
            font-family: 'Playfair Display', serif;
            color: var(--secondary-color);
            font-size: 22pt;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 15px;
            margin-bottom: 25px;
        }
        
        .card {
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #eaeff5;
        }

        .controls-row {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .control-group {
            flex: 1;
            min-width: 200px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .control-group input,
        .control-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #dce1e5;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
            box-sizing: border-box;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background-color: var(--secondary-color);
            color: var(--white);
            width: 100%;
            justify-content: center;
        }
        .btn:hover {
            opacity: 0.9;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 10pt;
        }

        th, td {
            border: 1px solid #dee2e6;
            padding: 10px;
            text-align: left;
            vertical-align: top;
        }

        th {
            background-color: var(--bg-color);
            font-weight: 700;
            font-family: 'Lora', serif;
        }
        
        .table-container {
            overflow-x: auto;
        }

        .payslip, .certificate {
            border: 1px solid #dce1e5;
            border-radius: 12px;
            padding: 25px;
            background: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-top: 20px;
        }
        
        .payslip-header, .certificate-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 4px solid var(--primary-color);
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        
        .document-title-area h1 {
            font-family: 'Playfair Display', serif;
            color: var(--primary-color);
            font-size: 28pt;
            margin: 0;
            text-align: right;
        }

        .footer {
            text-align: center;
            font-size: 9pt;
            color: #777;
            margin-top: 40px;
            border-top: 1px solid #ccc;
            padding-top: 20px;
        }
        
        #payslip-view, #certificate-view {
            margin-top: 20px;
        }
        
        .payslip-section-title {
            font-family: 'Lora', serif;
            font-weight: 700;
            color: var(--secondary-color);
            background-color: var(--bg-color);
            padding: 8px;
            margin-top: 20px;
            border-radius: 4px;
        }
        
        .payslip-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .payslip-grid-item table {
            margin-top: 5px;
        }

        .payslip-grid-item table td {
            border: none;
            padding: 4px 0;
        }

        .payslip-grid-item table td:first-child {
            font-weight: 500;
            width: 40%;
        }

        #file-name {
            margin-top: 10px;
            font-style: italic;
            color: var(--secondary-color);
        }

        /* Print-specific styles */
        @media print {
            body {
                background-color: #fff;
                padding: 0;
                margin: 0;
            }
            .container, .card, .payslip, .certificate {
                box-shadow: none;
                border: none;
                margin: 0;
                padding: 0;
                width: 100%;
                max-width: 100%;
            }
            .no-print {
                display: none;
            }
            @page {
                size: letter;
                margin: 0.5in;
            }
        }

    </style>
</head>
<body>
    <div class="container">
        <header class="no-print">
            <div>
                <div class="app-title">Z-BridgePay Document Architect</div>
                <div class="app-subtitle">Payroll Register ‚Ä¢ Payslip Generator ‚Ä¢ Certificate Generator</div>
            </div>
            <img src="https://github.com/Z-Insights/ZBridgePay/blob/main/Z-BridgePay.jpeg?raw=true" alt="Z-BridgePay Logo" class="logo">
        </header>
        
        <div class="nav-tabs no-print">
            <div class="tab active" data-tab="payroll">Payroll Register</div>
            <div class="tab" data-tab="payslips">Payslip Generator</div>
            <div class="tab" data-tab="certificates">Certificate Generator</div>
            <div class="tab" data-tab="database">Employee Database</div>
        </div>
        
        <!-- Payroll Register Tab -->
        <div class="tab-content active" id="payroll-tab">
            <div class="card">
                <h2 class="section-title">Weekly Payroll Register</h2>
                <div class="controls-row no-print">
                    <div class="control-group">
                        <label for="payrollFile">Upload Weekly Timesheet (.csv, .xlsx)</label>
                        <input type="file" id="payrollFile" accept=".csv,.xlsx">
                        <div id="file-name"></div>
                    </div>
                     <div class="control-group">
                        <label for="exchangeRate">USD to PHP Exchange Rate</label>
                        <input type="number" id="exchangeRate" value="58.75" step="0.01">
                    </div>
                    <div class="control-group">
                        <label for="payPeriodStart">Pay Period Start</label>
                        <input type="date" id="payPeriodStart">
                    </div>
                    <div class="control-group">
                        <label for="payPeriodEnd">Pay Period End</label>
                        <input type="date" id="payPeriodEnd">
                    </div>
                    <div class="control-group">
                        <button class="btn" id="processPayrollBtn">Process Payroll</button>
                    </div>
                     <div class="control-group">
                        <button class="btn" id="printReportBtn" style="background-color: var(--accent-color); color: var(--primary-color);">Print Report</button>
                    </div>
                </div>
                <div class="table-container">
                    <table id="payroll-register-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Full Name</th>
                                <th>Rate ($)</th>
                                <th>Hours</th>
                                <th>PTO Hours</th>
                                <th>Gross Hourly Pay ($)</th>
                                <th>Gross PTO ($)</th>
                                <th>Commissions ($)</th>
                                <th>Bonus ($)</th>
                                <th>Health Card ($)</th>
                                <th>SSS Reimb. ($)</th>
                                <th>Pag-IBIG Reimb. ($)</th>
                                <th>PhilHealth Reimb. ($)</th>
                                <th>Cash Adv/Loans ($)</th>
                                <th>Adjustments ($)</th>
                                <th>Total Gross Pay ($)</th>
                                <th>Take Home Pay ($)</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                        <tfoot></tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Payslip Generator Tab -->
        <div class="tab-content" id="payslips-tab">
            <div class="card">
                <h2 class="section-title">Payslip Generator</h2>
                 <div class="controls-row no-print">
                    <div class="control-group">
                        <label for="payslipEmployeeSelect">Select Employee</label>
                        <select id="payslipEmployeeSelect">
                            <option value="">-- Select Employee --</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <button class="btn" id="generatePayslipBtn">Generate Payslip</button>
                    </div>
                     <div class="control-group">
                        <button class="btn" id="printPayslipBtn" style="background-color: var(--accent-color); color: var(--primary-color);">Print Payslip</button>
                    </div>
                </div>
                <div id="payslip-view"></div>
            </div>
        </div>

        <!-- Certificate Generator Tab -->
        <div class="tab-content" id="certificates-tab">
            <div class="card">
                 <h2 class="section-title">Certificate Generator</h2>
                 <div class="controls-row no-print">
                    <div class="control-group">
                        <label for="certEmployeeSelect">Select Employee</label>
                        <select id="certEmployeeSelect">
                             <option value="">-- Select Employee --</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="certDate">Date Issued</label>
                        <input type="date" id="certDate">
                    </div>
                    <div class="control-group">
                        <button class="btn" id="generateCertBtn">Generate Certificate</button>
                    </div>
                     <div class="control-group">
                        <button class="btn" id="printCertBtn" style="background-color: var(--accent-color); color: var(--primary-color);">Print Certificate</button>
                    </div>
                </div>
                <div id="certificate-view"></div>
            </div>
        </div>
        
        <!-- Employee Database Tab -->
        <div class="tab-content" id="database-tab">
            <div class="card">
                <h2 class="section-title">Employee Database</h2>
                 <div class="table-container">
                    <table id="employee-database-table">
                        <thead>
                            <tr>
                                <th>Employee ID</th>
                                <th>Full Name</th>
                                <th>Designation</th>
                                <th>Assignment</th>
                                <th>Status</th>
                                <th>Hourly Rate ($)</th>
                                <th>Work Email</th>
                                <th>Date of Joining</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script>
    // --- EMBEDDED KNOWLEDGE BASE & DATA ---
    // This is the master database for all employees.
    // It should be updated manually when new employees are added.
    const employeeDatabase = [
        { "id": "ZBP-0000", "fullName": "Zaphyr Zur Pomicpic", "designation": "Director of Operations", "assignment": "Client A, Client B", "status": "Active", "rate": 12.00, "workEmail": "z.pomicpic@example.com", "joinDate": "2018-11-26", "address": "Block 2 Lot 6 Rambutan St. Tierra Verde Village, Sasa, Davao, Davao Del Sur, 8000, Philippines", "sss": "34-1234567-8", "pagibig": "1234-5678-9012", "philhealth": "01-0123456789-0", "tin": "123-456-789-000", "bankName": "BDO", "accountNumber": "0012-3456-7890" },
        { "id": "ZBP-1004", "fullName": "Fatima May Namalata", "designation": "Business Development Manager", "assignment": "Client A", "status": "Active", "rate": 6.00, "workEmail": "f.namalata@example.com", "joinDate": "2020-02-17", "address": "48 MARS STREET MACASANDIG, CAGAYAN DE ORO, MISAMIS ORIENTAL, 9000, Philippines", "sss": "34-2345678-9", "pagibig": "2345-6789-0123", "philhealth": "02-0234567890-1", "tin": "234-567-890-000", "bankName": "BPI", "accountNumber": "1123-4567-8901" },
        { "id": "ZBP-1050", "fullName": "Shelly (Michelle) Jose", "designation": "Maintenance Manager", "assignment": "Client B", "status": "Active", "rate": 4.75, "workEmail": "s.jose@example.com", "joinDate": "2022-03-18", "address": "Block 1 Lot 49 Kensington 21, Lancaster New City, General Trias, Cavite, 4107, Philippines", "sss": "34-3456789-0", "pagibig": "3456-7890-1234", "philhealth": "03-0345678901-2", "tin": "345-678-901-000", "bankName": "Metrobank", "accountNumber": "2234-5678-9012" },
        { "id": "ZBP-1005", "fullName": "Mary Galillaga", "designation": "Customer Success Rep", "assignment": "Client A", "status": "Active", "rate": 4.25, "workEmail": "m.galillaga@example.com", "joinDate": "2022-05-06", "address": "7350 Maria Clara St. La Huerta, Paranaque City, Manila, 1700, Philippines", "sss": "34-4567890-1", "pagibig": "4567-8901-2345", "philhealth": "04-0456789012-3", "tin": "456-789-012-000", "bankName": "BPI", "accountNumber": "3345-6789-0123" },
        { "id": "ZBP-1070", "fullName": "Belle (Maybelline) Martinez", "designation": "Customer Success Rep", "assignment": "Client A", "status": "Active", "rate": 5.00, "workEmail": "b.martinez@example.com", "joinDate": "2023-01-09", "address": "89 S Mateo Street, Taytay, Rizal, 1920, Philippines", "sss": "34-5678901-2", "pagibig": "5678-9012-3456", "philhealth": "05-0567890123-4", "tin": "567-890-123-000", "bankName": "BDO", "accountNumber": "4456-7890-1234" }
    ];
    
    let processedPayrollData = [];
    let currentExchangeRate = 58.75;

    document.addEventListener('DOMContentLoaded', function() {
        // --- INITIALIZATION ---
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const payrollFileInput = document.getElementById('payrollFile');
        const processPayrollBtn = document.getElementById('processPayrollBtn');
        const payrollTableBody = document.querySelector('#payroll-register-table tbody');
        const employeeDbTableBody = document.querySelector('#employee-database-table tbody');
        const payslipEmployeeSelect = document.getElementById('payslipEmployeeSelect');
        const certEmployeeSelect = document.getElementById('certEmployeeSelect');
        const generatePayslipBtn = document.getElementById('generatePayslipBtn');
        const generateCertBtn = document.getElementById('generateCertBtn');
        const payslipView = document.getElementById('payslip-view');
        const certificateView = document.getElementById('certificate-view');
        const printReportBtn = document.getElementById('printReportBtn');
        const printPayslipBtn = document.getElementById('printPayslipBtn');
        const printCertBtn = document.getElementById('printCertBtn');
        const fileNameDisplay = document.getElementById('file-name');
        
        // Set default dates for the pay period to the current week
        const today = new Date();
        const firstDayOfWeek = new Date(today.setDate(today.getDate() - today.getDay() + 1));
        const lastDayOfWeek = new Date(firstDayOfWeek);
        lastDayOfWeek.setDate(lastDayOfWeek.getDate() + 6);
        document.getElementById('payPeriodStart').valueAsDate = firstDayOfWeek;
        document.getElementById('payPeriodEnd').valueAsDate = lastDayOfWeek;
        document.getElementById('certDate').valueAsDate = new Date();


        // --- CORE APPLICATION LOGIC ---

        // Handles switching between the main tabs of the application
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(tc => tc.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
            });
        });
        
        // Attaches event listener to the file input to show the selected file's name
        payrollFileInput.addEventListener('change', (event) => {
             if (event.target.files.length > 0) {
                fileNameDisplay.textContent = `Selected file: ${event.target.files[0].name}`;
            } else {
                fileNameDisplay.textContent = '';
            }
        });

        // Main trigger for processing the uploaded payroll file
        processPayrollBtn.addEventListener('click', () => {
            const file = payrollFileInput.files[0];
            if (!file) {
                alert('Please upload a payroll timesheet file first.');
                return;
            }
            currentExchangeRate = parseFloat(document.getElementById('exchangeRate').value) || 58.75;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = e.target.result;
                let sheetData;
                try {
                    // Process either .xlsx or .csv files
                    if (file.name.endsWith('.xlsx')) {
                        const workbook = XLSX.read(data, { type: 'binary' });
                        const sheetName = workbook.SheetNames[0];
                        sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });
                    } else if (file.name.endsWith('.csv')) {
                        const parsed = Papa.parse(data, { header: false });
                        sheetData = parsed.data;
                    } else { throw new Error("Unsupported file type."); }
                    
                    parseAndCalculatePayroll(sheetData);

                } catch (error) {
                    console.error("Error processing file:", error);
                    alert("Error processing file. Please ensure it's a valid .csv or .xlsx file and the format is correct.");
                }
            };
            
            if (file.name.endsWith('.xlsx')) { reader.readAsBinaryString(file); } 
            else { reader.readAsText(file); }
        });

        // Parses the data from the uploaded sheet and calculates payroll for each employee
        function parseAndCalculatePayroll(sheetData) {
            processedPayrollData = [];
            // Find the header row by looking for the 'employee' column
            let headerRowIndex = sheetData.findIndex(row => row.map(cell => String(cell || '').toLowerCase()).includes('employee'));
            if (headerRowIndex === -1) {
                 alert("Could not find a valid header row in the timesheet. The header must contain a column named 'Employee'.");
                 return;
            }
            
            const headers = sheetData[headerRowIndex].map(h => String(h || '').trim().toLowerCase());
            const dataRows = sheetData.slice(headerRowIndex + 1);

            // Map expected headers to their index in the sheet
            const headerMap = {
                'employee': headers.indexOf('employee'),
                'weekly hours rendered': headers.indexOf('weekly hours rendered'),
                'paid timeoff hours': headers.indexOf('paid timeoff hours'),
                'commissions': headers.indexOf('commissions'),
                'bonus': headers.indexOf('bonus'),
                'health card credit': headers.indexOf('health card credit'),
                'sss': headers.indexOf('sss'),
                'pag ibig': headers.indexOf('pag ibig'),
                'philhealth': headers.indexOf('philhealth'),
                'cash adv/loans': headers.indexOf('cash adv/loans'),
                'compliance adjustment': headers.indexOf('compliance adjustment'),
            };
            
            // Iterate over each data row to calculate payroll
            dataRows.forEach(row => {
                const employeeName = row[headerMap['employee']];
                if (!employeeName) return; // Skip empty rows

                // Find the corresponding employee in the master database
                const employee = employeeDatabase.find(emp => emp.fullName.toLowerCase() === employeeName.toLowerCase());
                if (!employee) {
                    console.warn(`Employee not found in database: ${employeeName}`);
                    return; // Skip if employee not in our master list
                }

                const getNumericValue = (key) => parseFloat(row[headerMap[key]]) || 0;

                // Extract all financial data from the row
                const weeklyHours = getNumericValue('weekly hours rendered');
                const ptoHours = getNumericValue('paid timeoff hours');
                const rate = employee.rate || 0;
                const grossHourlyPay = weeklyHours * rate;
                const grossPtoPay = ptoHours * rate;
                const commissions = getNumericValue('commissions');
                const bonus = getNumericValue('bonus');
                const healthCard = getNumericValue('health card credit');
                const sss = getNumericValue('sss');
                const pagibig = getNumericValue('pag ibig');
                const philhealth = getNumericValue('philhealth');
                const loans = getNumericValue('cash adv/loans');
                const adjustments = getNumericValue('compliance adjustment');

                // Calculate final pay numbers
                const totalGrossPay = grossHourlyPay + grossPtoPay + commissions + bonus + healthCard + sss + pagibig + philhealth + adjustments;
                const takeHomePay = totalGrossPay - loans;
                
                // Store the calculated data
                processedPayrollData.push({
                    id: employee.id, fullName: employee.fullName, rate, weeklyHours, ptoHours, grossHourlyPay, grossPtoPay,
                    commissions, bonus, healthCard, sss, pagibig, philhealth, loans, adjustments, totalGrossPay, takeHomePay
                });
            });

            renderPayrollTable();
            populateEmployeeSelects();
            alert('Payroll processed successfully. You can now generate payslips and certificates.');
        }

        // Renders the main payroll register table with processed data
        function renderPayrollTable() {
            payrollTableBody.innerHTML = '';
            let totals = { weeklyHours:0, ptoHours:0, grossHourlyPay:0, grossPtoPay:0, commissions:0, bonus:0, healthCard:0, sss:0, pagibig:0, philhealth:0, loans:0, adjustments:0, totalGrossPay:0, takeHomePay:0 };

            processedPayrollData.forEach(data => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${data.id}</td><td>${data.fullName}</td><td>${data.rate.toFixed(2)}</td>
                    <td>${data.weeklyHours.toFixed(2)}</td><td>${data.ptoHours.toFixed(2)}</td>
                    <td>${data.grossHourlyPay.toFixed(2)}</td><td>${data.grossPtoPay.toFixed(2)}</td>
                    <td>${data.commissions.toFixed(2)}</td><td>${data.bonus.toFixed(2)}</td>
                    <td>${data.healthCard.toFixed(2)}</td><td>${data.sss.toFixed(2)}</td>
                    <td>${data.pagibig.toFixed(2)}</td><td>${data.philhealth.toFixed(2)}</td>
                    <td>${data.loans.toFixed(2)}</td><td>${data.adjustments.toFixed(2)}</td>
                    <td><strong>${data.totalGrossPay.toFixed(2)}</strong></td><td><strong>${data.takeHomePay.toFixed(2)}</strong></td>
                `;
                payrollTableBody.appendChild(row);
                for (const key in totals) { totals[key] += data[key] || 0; }
            });
            
            // Render the footer with totals
            const tfoot = document.querySelector('#payroll-register-table tfoot');
            tfoot.innerHTML = `
                <tr style="font-weight: bold; background-color: var(--bg-color);">
                    <td colspan="3">TOTALS</td>
                    <td>${totals.weeklyHours.toFixed(2)}</td><td>${totals.ptoHours.toFixed(2)}</td>
                    <td>${totals.grossHourlyPay.toFixed(2)}</td><td>${totals.grossPtoPay.toFixed(2)}</td>
                    <td>${totals.commissions.toFixed(2)}</td><td>${totals.bonus.toFixed(2)}</td>
                    <td>${totals.healthCard.toFixed(2)}</td><td>${totals.sss.toFixed(2)}</td>
                    <td>${totals.pagibig.toFixed(2)}</td><td>${totals.philhealth.toFixed(2)}</td>
                    <td>${totals.loans.toFixed(2)}</td><td>${totals.adjustments.toFixed(2)}</td>
                    <td>${totals.totalGrossPay.toFixed(2)}</td><td>${totals.takeHomePay.toFixed(2)}</td>
                </tr>
            `;
        }

        // Populates the employee dropdowns after payroll is processed
        function populateEmployeeSelects() {
            payslipEmployeeSelect.innerHTML = '<option value="">-- Select Employee --</option>';
            certEmployeeSelect.innerHTML = '<option value="">-- Select Employee --</option>';
            processedPayrollData.forEach(emp => {
                const option = `<option value="${emp.id}">${emp.fullName}</option>`;
                payslipEmployeeSelect.innerHTML += option;
                certEmployeeSelect.innerHTML += option;
            });
        }
        
        // --- DOCUMENT GENERATION ---

        // Triggers payslip generation for the selected employee
        generatePayslipBtn.addEventListener('click', () => {
            const selectedId = payslipEmployeeSelect.value;
            if (!selectedId) { alert('Please select an employee to generate a payslip.'); return; }
            const payrollData = processedPayrollData.find(p => p.id === selectedId);
            const employeeData = employeeDatabase.find(e => e.id === selectedId);
            renderPayslip(payrollData, employeeData);
        });
        
        // Triggers certificate generation for the selected employee
        generateCertBtn.addEventListener('click', () => {
             const selectedId = certEmployeeSelect.value;
            if (!selectedId) { alert('Please select an employee to generate a certificate.'); return; }
            const payrollData = processedPayrollData.find(p => p.id === selectedId);
            const employeeData = employeeDatabase.find(e => e.id === selectedId);
            renderCertificate(payrollData, employeeData);
        });

        // Renders the HTML for the payslip
        function renderPayslip(payrollData, employeeData) {
            if (!payrollData || !employeeData) {
                payslipView.innerHTML = `<p style="color: var(--danger-color);">Could not generate payslip. Data not found.</p>`;
                return;
            }
            // Helper function to format currency
            const toPHP = (amount) => (amount * currentExchangeRate).toLocaleString('en-US', { style: 'currency', currency: 'PHP' });
            
            // Local calculations for the detailed payslip format
            const grossPayUSD = payrollData.grossHourlyPay + payrollData.grossPtoPay + payrollData.commissions + payrollData.bonus;
            const sssUSD = payrollData.sss;
            const pagibigUSD = payrollData.pagibig;
            const philhealthUSD = payrollData.philhealth;
            const withholdingTaxUSD = payrollData.adjustments;
            const loansUSD = payrollData.loans;
            
            const totalGovDeductionsUSD = sssUSD + pagibigUSD + philhealthUSD;
            const totalDeductionsUSD = totalGovDeductionsUSD + withholdingTaxUSD + loansUSD;
            
            const netPayUSD = grossPayUSD - totalDeductionsUSD;
            const reimbursementUSD = totalGovDeductionsUSD;
            const totalCreditedUSD = netPayUSD + reimbursementUSD;

            // Get dates for the payslip header
            const payPeriodStart = new Date(document.getElementById('payPeriodStart').value).toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
            const payPeriodEnd = new Date(document.getElementById('payPeriodEnd').value).toLocaleDateString('en-US', { day: 'numeric', year: 'numeric' });
            const payDate = new Date(document.getElementById('payPeriodEnd').value);
            payDate.setDate(payDate.getDate() + 1);

            // The main HTML structure for the payslip
            payslipView.innerHTML = `
                <div class="payslip" id="payslip-to-print">
                    <div class="payslip-header">
                        <div class="logo-area">
                            <img src="https://github.com/Z-Insights/ZBridgePay/blob/main/Z-BridgePay.jpeg?raw=true" alt="Z-BridgePay Logo" style="max-height: 70px; border-radius: 8px;">
                        </div>
                        <div class="document-title-area">
                            <h1>Weekly Payslip</h1>
                            <p style="text-align:right; font-family: 'Lora', serif;">
                                <strong>Pay Period:</strong> ${payPeriodStart} - ${payPeriodEnd}<br>
                                <strong>Pay Date:</strong> ${payDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}
                            </p>
                        </div>
                    </div>
                    
                    <div class="payslip-grid">
                        <div class="payslip-grid-item">
                            <h3 class="payslip-section-title">üë§ Employee Details</h3>
                            <table>
                                <tr><td>Full Name:</td><td>${employeeData.fullName}</td></tr>
                                <tr><td>Employee ID:</td><td>${employeeData.id}</td></tr>
                                <tr><td>Position:</td><td>${employeeData.designation}</td></tr>
                                <tr><td>Work Location:</td><td>${employeeData.address.split(',').slice(-3).join(', ').trim()}</td></tr>
                                <tr><td>Govt. IDs:</td><td>SSS: ${employeeData.sss} | PhilHealth: ${employeeData.philhealth} | Pag-IBIG: ${employeeData.pagibig} | TIN: ${employeeData.tin}</td></tr>
                            </table>
                        </div>
                        <div class="payslip-grid-item">
                            <h3 class="payslip-section-title">üåê Employer Details</h3>
                             <table>
                                <tr><td>Company:</td><td>Z-BridgePay Solutions</td></tr>
                                <tr><td>Address:</td><td>123 Innovation Drive, Austin, TX, USA</td></tr>
                                <tr><td>Contact:</td><td>payroll@z-bridgepay.com</td></tr>
                            </table>
                        </div>
                    </div>
                    
                    <h3 class="payslip-section-title">üíµ Compensation Breakdown</h3>
                    <table style="font-size: 11pt;">
                       <thead><tr><th>Description</th><th style="text-align:right;">Amount (PHP)</th></tr></thead>
                       <tbody>
                            <tr><td>Basic Pay (${payrollData.weeklyHours.toFixed(2)} hrs @ $${payrollData.rate.toFixed(2)}/hr)</td><td style="text-align:right;">${toPHP(payrollData.grossHourlyPay)}</td></tr>
                            <tr><td>Overtime/PTO Pay (${payrollData.ptoHours.toFixed(2)} hrs)</td><td style="text-align:right;">${toPHP(payrollData.grossPtoPay)}</td></tr>
                            <tr><td>Performance Bonus / Commissions</td><td style="text-align:right;">${toPHP(payrollData.commissions + payrollData.bonus)}</td></tr>
                            <tr style="font-weight:bold; background-color: var(--bg-color);"><td>Gross Pay</td><td style="text-align:right;">${toPHP(grossPayUSD)}</td></tr>
                       </tbody>
                    </table>

                    <h3 class="payslip-section-title">üìâ Deductions (Employee-Paid, Reimbursable by Company)</h3>
                    <table style="font-size: 11pt;">
                       <thead><tr><th>Description</th><th style="text-align:right;">Amount (PHP)</th></tr></thead>
                       <tbody>
                            <tr><td>SSS Contribution</td><td style="text-align:right;">(${toPHP(sssUSD)})</td></tr>
                            <tr><td>PhilHealth Contribution</td><td style="text-align:right;">(${toPHP(philhealthUSD)})</td></tr>
                            <tr><td>Pag-IBIG Contribution</td><td style="text-align:right;">(${toPHP(pagibigUSD)})</td></tr>
                            <tr><td>Withholding Tax (from Adjustments)</td><td style="text-align:right;">(${toPHP(withholdingTaxUSD)})</td></tr>
                            <tr><td>Cash Advance / Loans</td><td style="text-align:right;">(${toPHP(loansUSD)})</td></tr>
                            <tr style="font-weight:bold; background-color: var(--bg-color);"><td>Total Deductions</td><td style="text-align:right;">(${toPHP(totalDeductionsUSD)})</td></tr>
                       </tbody>
                    </table>
                    
                    <h3 class="payslip-section-title">üí∞ Net Pay & Reimbursement</h3>
                     <table style="font-size: 11pt;">
                       <thead><tr><th>Description</th><th style="text-align:right;">Amount (PHP)</th></tr></thead>
                       <tbody>
                            <tr style="font-weight:bold;"><td>Net Pay (Take-Home)</td><td style="text-align:right;">${toPHP(netPayUSD)}</td></tr>
                            <tr><td>Reimbursement of Gov‚Äôt Deductions</td><td style="text-align:right;">${toPHP(reimbursementUSD)}</td></tr>
                            <tr style="font-weight:bold; background-color: var(--secondary-color); color: var(--white); font-size: 1.2em;"><td>Total Credited to Bank</td><td style="text-align:right;">${toPHP(totalCreditedUSD)}</td></tr>
                       </tbody>
                    </table>

                    <div class="payslip-grid" style="margin-top: 20px;">
                        <div class="payslip-grid-item">
                            <h3 class="payslip-section-title">üè¶ Bank Deposit Details</h3>
                            <table>
                                <tr><td>Bank Name:</td><td>${employeeData.bankName}</td></tr>
                                <tr><td>Account Number:</td><td>${employeeData.accountNumber}</td></tr>
                                <tr><td>Payment Method:</td><td>Direct Deposit</td></tr>
                                <tr><td>Currency:</td><td>PHP</td></tr>
                            </table>
                        </div>
                        <div class="payslip-grid-item">
                           <h3 class="payslip-section-title">üìå Notes for Verification</h3>
                           <ul style="font-size: 9pt; padding-left: 20px; margin-top: 10px;">
                                <li>This payslip reflects weekly compensation for a remote employee under a foreign employer.</li>
                                <li>All Philippine government-mandated deductions are paid by the employee and reimbursed in full by the company.</li>
                                <li>This document is valid for income verification for housing or car loan applications.</li>
                                <li>For questions, contact HR at payroll@z-bridgepay.com.</li>
                           </ul>
                        </div>
                    </div>

                    <div class="footer">
                        <p>Z-BridgePay Solutions | 123 Innovation Drive, Austin, TX, USA</p>
                    </div>
                </div>
            `;
        }
        
        // Renders the HTML for the Certificate of Employment
        function renderCertificate(payrollData, employeeData) {
            if (!payrollData || !employeeData) {
                certificateView.innerHTML = `<p style="color: var(--danger-color);">Could not generate certificate. Data not found.</p>`;
                return;
            }
            const issueDate = new Date(document.getElementById('certDate').value).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            const joinDate = new Date(employeeData.joinDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            
            certificateView.innerHTML = `
                 <div class="certificate" id="certificate-to-print">
                    <div class="certificate-header">
                        <div class="logo-area">
                            <img src="https://github.com/Z-Insights/ZBridgePay/blob/main/Z-BridgePay.jpeg?raw=true" alt="Z-BridgePay Logo" style="max-height: 70px; border-radius: 8px;">
                        </div>
                        <div class="document-title-area">
                            <h1>Certificate of Employment & Compensation</h1>
                        </div>
                    </div>
                    <div style="padding: 20px; line-height: 1.8; font-size: 12pt;">
                        <p style="text-align: right;"><strong>Date:</strong> ${issueDate}</p>
                        <h2 style="text-align: center; font-family: 'Playfair Display', serif; color: var(--primary-color); font-size: 18pt; margin: 30px 0;">TO WHOM IT MAY CONCERN:</h2>
                        <p>This is to certify that <strong>${employeeData.fullName}</strong> is an active, full-time remote contractor for <strong>Z-BridgePay Solutions</strong>.</p>
                        <p>He/She holds the position of <strong>${employeeData.designation}</strong>, and has been engaged with the company since <strong>${joinDate}</strong>.</p>
                        <p>This certification is issued to attest that for the pay period ending on the date of this certificate, the contractor has an average weekly compensation, inclusive of all bonuses and fees, amounting to approximately <strong>$${payrollData.takeHomePay.toFixed(2)} USD</strong>.</p>
                        <p>This document is issued upon the request of the aforementioned individual for whatever legal and lawful purpose it may serve.</p>
                        
                        <div style="margin-top: 80px;">
                            <p>Sincerely,</p>
                            <div style="margin-top: 60px; display: inline-block; border-top: 1px solid #000; padding-top: 5px;">
                                <strong>Zaphyr Zur Pomicpic</strong><br>
                                Authorizing Manager<br>
                                Z-BridgePay Solutions
                            </div>
                        </div>
                    </div>
                     <div class="footer">
                        <p>Z-BridgePay Solutions | 123 Innovation Drive, Austin, TX, USA</p>
                        <p>This is a legally binding document. All information contained herein is accurate as of the date of generation.</p>
                    </div>
                </div>
            `;
        }

        // Renders the employee database table on its dedicated tab
        function renderEmployeeDatabase() {
            employeeDbTableBody.innerHTML = '';
            employeeDatabase.forEach(emp => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${emp.id}</td><td>${emp.fullName}</td><td>${emp.designation}</td>
                    <td>${emp.assignment}</td><td>${emp.status}</td>
                    <td>${emp.rate ? emp.rate.toFixed(2) : 'N/A'}</td>
                    <td>${emp.workEmail}</td><td>${emp.joinDate}</td>
                `;
                employeeDbTableBody.appendChild(row);
            });
        }
        
        // --- PRINTING & PDF EXPORT ---

        // Prints the main payroll register view
        printReportBtn.addEventListener('click', () => {
             const payrollTab = document.getElementById('payroll-tab');
             const wasActive = payrollTab.classList.contains('active');
             if (!wasActive) payrollTab.classList.add('active'); // Ensure content is visible for printing
             window.print();
             if (!wasActive) payrollTab.classList.remove('active');
        });
        
        // Exports the generated payslip to a PDF file
        printPayslipBtn.addEventListener('click', () => {
            const content = document.getElementById('payslip-to-print');
            if (content) {
                html2canvas(content).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({ orientation: 'p', unit: 'px', format: [canvas.width, canvas.height] });
                    pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                    pdf.save(`${payslipEmployeeSelect.options[payslipEmployeeSelect.selectedIndex].text}_payslip.pdf`);
                });
            } else { alert('Please generate a payslip first.'); }
        });
        
        // Exports the generated certificate to a PDF file
        printCertBtn.addEventListener('click', () => {
             const content = document.getElementById('certificate-to-print');
            if (content) {
                html2canvas(content).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({ orientation: 'p', unit: 'px', format: [canvas.width, canvas.height] });
                    pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                    pdf.save(`${certEmployeeSelect.options[certEmployeeSelect.selectedIndex].text}_certificate.pdf`);
                });
            } else { alert('Please generate a certificate first.'); }
        });

        // Initial population of the database tab on page load
        renderEmployeeDatabase();
    });
    </script>
</body>
</html>
